name: Build Package only test

on:
  workflow_dispatch:
    inputs:
      package_name:
        description: "Name of the package to build"
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Install Docker automatically
      - name: Install Docker
        run: |
          set -e
          curl -fsSL https://get.docker.com -o get-docker.sh
          sudo sh get-docker.sh
          docker --version
          
      # Step 3: Set up QEMU for multi-arch (optional)
      - name: Set up QEMU
        run: |
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

      # Step 4: Build package inside Docker container
      - name: Build package
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace ubuntu:22.04 bash -c "
            apt-get update
            apt-get install -y curl wget unzip software-properties-common
            ./scripts/setup-android-sdk.sh
            apt-get install -y python3.11 python3.11-venv python3.11-distutils
            python3.11 --version
            ./build-package.sh -a aarch64 ${{ github.event.inputs.package_name }}
          "

      # Step 5: Sanitize filenames
      - name: Sanitize filenames
        if: success()
        run: |
          cd output
          for file in *; do
            new_name=$(echo "$file" | tr ':<>|*?"\r\n ' '_')
            if [ "$file" != "$new_name" ]; then
              mv "$file" "$new_name"
            fi
          done

      # Step 6: Upload artifacts
      - name: Upload built packages
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: built-packages
          path: output/
